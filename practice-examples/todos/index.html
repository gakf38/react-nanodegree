<!DOCTYPE html>
<html>

<head>
	<title>Udacity Todos Goals</title>
</head>

<body>

	<!-- Todo List UI -->
	<div>
		<h1>Todo List</h1>
		<input id='todo' type='text' placeholder='Add Todo' />
		<button id='todoBtn'>Add Todo</button>
		<ul id='todos'></ul>
	</div>

	<!-- Goals UI -->
	<div>
		<h1>Goals</h1>
		<input id='goal' type='text' placeholder='Add Goal' />
		<button id='goalBtn'>Add Goal</button>
		<ul id='goals'></ul>
	</div>


	<script type="text/javascript">

		// Library Code - Close to a library that would come from NPM package
		function createStore(reducer) {

			/*
				The store should have 4 parts:
				1. the state
				2. interaction to get the state
				3. interaction to listen for changes to the state
				4. interaction to update the state
			*/

			// Define the State of the Store
			let state 

			// Define a way to get the State of the Store
			const getState = () => state

			// Define a way to listen for changes to the state
			let listeners = []
			const subscribe = (listener) => {
				// Add the listener to the listeners array
				listeners.push(listener)
				// Return a function that can be invoked to 'unsubscribe' the added listener
				return () => {
					listeners = listeners.filter((l) => l !== listener)
				}
			}

			// Define a way to update the state of the store
			const dispatch = (action) => {
				state = reducer(state, action)
				listeners.forEach((listener) => listener())
			}


			return {
				getState,
				subscribe,
				dispatch
			}
		}

		// App Code - Close to code that the user would write

		// Action type constants
		const ADD_TODO = 'ADD_TODO'
		const REMOVE_TODO = 'REMOVE_TODO'
		const TOGGLE_TODO = 'TOGGLE_TODO'
		const ADD_GOAL = 'ADD_GOAL'
		const REMOVE_GOAL = 'REMOVE_GOAL'

		// Action Creator Functions
		function addTodoAction (todo) {
			return {
				type: ADD_TODO,
				todo
			}
		}

		function removeTodoAction (id) {
			return {
				type: REMOVE_TODO,
				id
			}
		}

		function toggleTodoAction (id) {
			return {
				type: TOGGLE_TODO,
				id
			}
		}

		function addGoalAction (goal) {
			return {
				type: ADD_GOAL,
				goal
			}
		}

		function removeGoalAction (id) {
			return {
				type: REMOVE_GOAL,
				id
			}
		}

		// TODOS Reducer Function
		function todos (state = [], action) {

			switch (action.type) {

				case ADD_TODO :
					return state.concat([action.todo])

				case REMOVE_TODO :
					return state.filter((todo) => todo.id !== action.id)

				case TOGGLE_TODO :
					return state.map((todo) => todo.id !== action.id ? todo : 
						Object.assign({}, todo, { complete: !todo.complete })
					)

				default :
					return state
			}
		}

		// GOALS Reducer Function
		function goals (state = [], action) {

			switch (action.type) {

				case ADD_GOAL:
					return state.concat([action.goal])

				case REMOVE_GOAL:
					return state.filter((goal) => goal.id !== action.id)

				default: 
					return state
			}
		}

		// Root Reducer Function
		function app (state = {}, action) {

			return {
				todos: todos(state.todos, action),
				goals: goals(state.goals, action)
			}
		}

		// Generate a Random ID
		function generateId () {
		  return Math.random().toString(36).substring(2) + (new Date()).getTime().toString(36);
		}

		// Create the Store
		const store = createStore(app)

		// Subscribe a listener to the Store
		store.subscribe(() => {

			const { todos, goals } = store.getState()

			document.getElementById('todos').innerHTML = ''
			document.getElementById('goals').innerHTML = ''

			todos.forEach(addTodoToDOM)
			goals.forEach(addGoalToDOM)
		})	

		// DOM Code -
		function addTodo() {
			// Get the name of the Todo
			const input = document.getElementById('todo')
			const name = input.value
			input.value = ''

			// Dispatch the addTodoAction with the retrieved todo name
			store.dispatch(addTodoAction({
			  name,
			  complete: false,
			  id: generateId()
			}))
		}

		function addGoal() {
			// Get the name of the Goal
			const input = document.getElementById('goal')
			const name = input.value
			input.value = ''

			// Dispatchthe addGoalAction with the retrieved goal name
			store.dispatch(addGoalAction({
			  name,
			  id: generateId()
			}))
		}

		// Add addTodo as the on click even to the Add Todo button
		document.getElementById('todoBtn').addEventListener('click', addTodo)

		// Add addGoal as the on click event to the Add Goal button
		document.getElementById('goalBtn').addEventListener('click', addGoal)

		// Create a Remove Button for each Todo/Goal Item
		function createRemoveButton (onClick) {
	       const removeBtn = document.createElement('button')
	       removeBtn.innerHTML = 'X'
	       removeBtn.addEventListener('click', onClick)
	       return removeBtn
	    }

	    // Add a Todo to the DOM
		function addTodoToDOM(todo) {

			const node = document.createElement('li')
			const text = document.createTextNode(todo.name)

			// Define the Remove Button
			const removeBtn = createRemoveButton(() => {
		        store.dispatch(removeTodoAction(todo.id))
		    })

			node.appendChild(text)
			node.appendChild(removeBtn)

			// Add a strike-through if the todo is complete
			node.style.textDecoration = todo.complete ? 'line-through' : 'none'

			// Toggle a todo's complete on click
			node.addEventListener('click', () => {
				store.dispatch(toggleTodoAction(todo.id))
			})

			document.getElementById('todos').appendChild(node)
		}

		// Add a Goald to the DOM
		function addGoalToDOM(goal) {

			const node = document.createElement('li')
			const text = document.createTextNode(goal.name)

			// Define the Remove Button
			const removeBtn = createRemoveButton(() => {
				store.dispatch(removeGoalAction(goal.id))
			})

			node.appendChild(text)
			node.appendChild(removeBtn)

			document.getElementById('goals').appendChild(node)
		}

	</script>

</body>

</html>